<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Code Viewer</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.2.0/diff.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0d1117;--surface:#161b22;--surface2:#1c2129;--border:#30363d;--text:#e6edf3;--text2:#8b949e;--accent:#58a6ff;--green:#3fb950;--orange:#d29922;--red:#f85149;--purple:#bc8cff}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex}
/* ä¸‰æ å¸ƒå±€ */
#projects-panel{width:260px;min-width:260px;border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;transition:width .3s ease, min-width .3s ease;position:relative}
#sessions-panel{width:300px;min-width:300px;border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;transition:width .3s ease, min-width .3s ease;position:relative}
#detail-panel{flex:1;display:flex;flex-direction:column;height:100vh;overflow:hidden}
.panel-header{padding:14px 16px;border-bottom:1px solid var(--border);font-size:18px;font-weight:600;color:var(--text2);background:var(--surface);flex-shrink:0;display:flex;align-items:center;gap:8px}
.panel-toggle{padding:6px 8px;border:1px solid var(--border);border-radius:4px;background:var(--surface2);color:var(--text2);cursor:pointer;flex-shrink:0;transition:all .2s}
.panel-toggle:hover{background:var(--border);color:var(--text)}
.panel-toggle .icon{font-size:16px;font-weight:600}
.panel-header .count{background:var(--border);border-radius:10px;padding:1px 8px;font-size:12px;font-weight:400}
.panel-list{flex:1;overflow-y:auto;padding:4px}
.panel-list::-webkit-scrollbar{width:6px}
.panel-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
/* é¡¹ç›®åˆ—è¡¨é¡¹ */
.project-item,.session-item{padding:10px 12px;border-radius:6px;cursor:pointer;margin:2px 4px;transition:background .15s}
.project-item:hover,.session-item:hover{background:var(--surface2)}
.project-item.active,.session-item.active{background:rgba(88,166,255,.15);border-left:2px solid var(--accent)}
.project-item .name{font-size:13px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.project-item .meta{font-size:11px;color:var(--text2);margin-top:3px;display:flex;justify-content:space-between}
/* ä¼šè¯åˆ—è¡¨é¡¹ */
.session-item .preview{font-size:13px;color:var(--text);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.session-item .meta{font-size:11px;color:var(--text2);margin-top:4px;display:flex;justify-content:space-between}
/* ç»Ÿè®¡æ  */
#stats-bar{padding:12px 20px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;display:none;flex-wrap:wrap;gap:6px 16px;position:relative}
.stat-item{font-size:18px;color:var(--text2);font-weight:500}
.stat-item span{color:var(--text);font-weight:600;margin-left:4px;font-size:18px}
.stat-item.input span{color:var(--accent)}
.stat-item.output span{color:var(--green)}
.stat-item.cache-create span{color:var(--orange)}
.stat-item.cache-read span{color:var(--purple)}
.stat-item.throughput,.stat-item.duration{font-size:16px}
.stat-item.throughput span,.stat-item.duration span{font-size:16px}
/* æ»šåŠ¨æŒ‰é’® */
.scroll-buttons{position:absolute;right:20px;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:8px;z-index:10}
.scroll-btn{width:36px;height:36px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:600;transition:all .2s}
.scroll-btn:hover{background:var(--border);color:var(--text);transform:translateY(-50%) scale(1.1)}
.scroll-btn:active{transform:translateY(-50%) scale(0.95)}
.scroll-btn.hidden{display:none}
/* è‡ªåŠ¨æ»šåŠ¨å¼€å…³æŒ‰é’® */
.auto-scroll-toggle{padding:6px 12px;border-radius:6px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);cursor:pointer;font-size:12px;font-weight:500;transition:all .2s;display:flex;align-items:center;gap:6px}
.auto-scroll-toggle:hover{background:var(--border);color:var(--text)}
.auto-scroll-toggle.active{background:rgba(88,166,255,.15);border-color:var(--accent);color:var(--accent)}
.auto-scroll-toggle .icon{font-size:14px}
/* æ¶ˆæ¯åŒºåŸŸ */
#messages{flex:1;overflow-y:auto;padding:16px 20px;position:relative}
#messages::-webkit-scrollbar{width:6px}
#messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
#messages .scroll-buttons{position:sticky;bottom:20px;right:20px;display:flex;flex-direction:column;gap:8px;pointer-events:none;z-index:10}
#messages .scroll-buttons .scroll-btn{pointer-events:auto}
.message{margin-bottom:16px;padding:12px 16px;border-radius:8px;border:1px solid var(--border);position:relative}
.message.user{background:rgba(88,166,255,.06);border-color:rgba(88,166,255,.2)}
.message.assistant{background:var(--surface)}
.message.system{background:transparent;border-color:var(--border);opacity:.6;font-size:12px}
.message.sidechain{opacity:.5;border-style:dashed}
.msg-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:12px;flex-wrap:wrap}
.msg-role{font-weight:600;text-transform:uppercase;font-size:11px;padding:2px 6px;border-radius:3px}
.msg-role.user{background:rgba(88,166,255,.2);color:var(--accent)}
.msg-role.assistant{background:rgba(63,185,80,.2);color:var(--green)}
.msg-role.system{background:rgba(139,148,158,.2);color:var(--text2)}
.msg-time{color:var(--text2);font-size:11px}
.msg-model{color:var(--purple);font-size:11px}
.msg-response-time{color:var(--orange);font-size:11px;font-weight:500}
.msg-stop{color:var(--text2);font-size:11px;font-style:italic}
.msg-tokens{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;font-size:11px}
.token-badge{padding:1px 6px;border-radius:3px;font-family:monospace}
.token-badge.input{background:rgba(88,166,255,.15);color:var(--accent)}
.token-badge.output{background:rgba(63,185,80,.15);color:var(--green)}
.token-badge.cache-create{background:rgba(210,153,34,.15);color:var(--orange)}
.token-badge.cache-read{background:rgba(188,140,255,.15);color:var(--purple)}
/* æ¶ˆæ¯å†…å®¹ */
.msg-body{font-size:14px;line-height:1.6}
.msg-body p{margin-bottom:8px}
.msg-body pre{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:12px;overflow-x:auto;margin:8px 0}
.msg-body code{font-family:'Fira Code',Consolas,monospace;font-size:13px}
.msg-body :not(pre)>code{background:var(--surface2);padding:1px 5px;border-radius:3px;font-size:12px}
.msg-body ul,.msg-body ol{padding-left:20px;margin-bottom:8px}
.msg-body blockquote{border-left:3px solid var(--border);padding-left:12px;color:var(--text2);margin:8px 0}
.msg-body table{border-collapse:collapse;margin:8px 0;width:100%}
.msg-body th,.msg-body td{border:1px solid var(--border);padding:6px 10px;text-align:left;font-size:13px}
.msg-body th{background:var(--surface)}
.msg-body img{max-width:100%}
/* å·¥å…·å— */
details.tool-block{margin:8px 0;border:1px solid var(--border);border-radius:6px;overflow:hidden}
details.tool-block summary{padding:8px 12px;background:var(--surface2);cursor:pointer;font-size:12px;color:var(--text2);font-family:monospace;user-select:none}
details.tool-block summary:hover{background:var(--border)}
details.tool-block .tool-content{padding:10px 12px;font-size:12px;max-height:400px;overflow:auto;background:var(--bg)}
details.tool-block .tool-content pre{margin:0;border:none;padding:0;background:transparent}
/* ç©ºçŠ¶æ€ */
.empty-state{display:flex;align-items:center;justify-content:center;height:100%;color:var(--text2);font-size:14px;text-align:center;padding:20px}
/* åŠ è½½ */
.loading{text-align:center;padding:20px;color:var(--text2);font-size:13px}
/* ä»£ç å·®å¼‚å¯¹æ¯” */
.diff-container{margin:12px 0;border:1px solid var(--border);border-radius:6px;overflow:hidden;background:var(--bg)}
.diff-header{padding:10px 16px;background:var(--surface2);border-bottom:1px solid var(--border);font-size:13px;color:var(--text2);display:flex;justify-content:space-between;align-items:center}
.diff-file-path{color:var(--text);font-weight:500;font-family:monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:80%}
.diff-stats{display:flex;gap:12px;font-size:12px}
.diff-stat{display:flex;align-items:center;gap:4px}
.diff-stat.added{color:var(--green)}
.diff-stat.removed{color:var(--red)}
.diff-stat.changed{color:var(--accent)}
.diff-wrapper{display:flex;font-family:'Fira Code',Consolas,monospace;font-size:12px}
.diff-old,.diff-new{flex:1;min-width:0}
.diff-old-header,.diff-new-header{padding:8px 12px;background:var(--surface);border-bottom:1px solid var(--border);color:var(--text2);font-weight:500;text-align:center;font-size:11px}
.diff-line{display:flex;min-height:20px}
.diff-line-num{padding:0 8px;color:var(--text2);background:var(--surface2);border-right:1px solid var(--border);font-size:11px;width:40px;text-align:right;flex-shrink:0}
.diff-line-content{padding:0 12px;flex:1;white-space:pre-wrap;word-break:break-all}
.diff-line.removed{background:rgba(248,81,73,0.1)}
.diff-line.removed .diff-line-content{background:rgba(248,81,73,0.15);color:var(--red)}
.diff-line.added{background:rgba(63,185,80,0.1)}
.diff-line.added .diff-line-content{background:rgba(63,185,80,0.15);color:var(--green)}
.diff-line.changed .diff-line-content{background:rgba(88,166,255,0.1);color:var(--accent)}
</style>
</head>
<body>

<div id="projects-panel">
  <div class="panel-header">
    é¡¹ç›®åˆ—è¡¨ <span class="count" id="project-count">0</span>
    <button class="panel-toggle" onclick="togglePanel('projects')" title="éšè—/æ˜¾ç¤ºé¡¹ç›®åˆ—è¡¨">
      <span class="icon" id="projects-toggle-icon">â®</span>
    </button>
  </div>
  <div class="panel-list" id="project-list"><div class="loading">åŠ è½½ä¸­...</div></div>
</div>

<div id="sessions-panel">
  <div class="panel-header">
    å¯¹è¯åˆ—è¡¨ <span class="count" id="session-count">0</span>
    <button class="panel-toggle" onclick="togglePanel('sessions')" title="éšè—/æ˜¾ç¤ºå¯¹è¯åˆ—è¡¨">
      <span class="icon" id="sessions-toggle-icon">â®</span>
    </button>
  </div>
  <div class="panel-list" id="session-list"><div class="empty-state">é€‰æ‹©ä¸€ä¸ªé¡¹ç›®</div></div>
</div>

<div id="detail-panel">
  <div id="stats-bar">
    <button class="auto-scroll-toggle active" id="auto-scroll-btn" onclick="toggleAutoScroll()" title="æ–°æ¶ˆæ¯è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨">
      <span class="icon">ğŸ“</span>
      <span class="text">è‡ªåŠ¨æ»šåŠ¨</span>
    </button>
    <div class="scroll-buttons">
      <button class="scroll-btn" onclick="scrollToTop()" title="æ»šåŠ¨åˆ°é¡¶éƒ¨">â†‘</button>
      <button class="scroll-btn" onclick="scrollToBottom()" title="æ»šåŠ¨åˆ°åº•éƒ¨">â†“</button>
    </div>
  </div>
  <div id="messages">
    <div class="empty-state">é€‰æ‹©ä¸€ä¸ªå¯¹è¯æŸ¥çœ‹è¯¦æƒ…</div>
    <div class="scroll-buttons" style="position:absolute">
      <button class="scroll-btn" onclick="scrollToTop()" title="æ»šåŠ¨åˆ°é¡¶éƒ¨">â†‘</button>
      <button class="scroll-btn" onclick="scrollToBottom()" title="æ»šåŠ¨åˆ°åº•éƒ¨">â†“</button>
    </div>
  </div>
</div>

<script>
marked.setOptions({
  highlight: (code, lang) => {
    if (lang && hljs.getLanguage(lang)) return hljs.highlight(code, { language: lang }).value;
    return hljs.highlightAuto(code).value;
  },
  breaks: true
});

// å…¨å±€çŠ¶æ€å˜é‡
let currentProject = null;
let currentSession = null;
let currentMessageCount = 0;
let autoRefreshTimers = {};
let autoScrollToBottom = true;
const REFRESH_INTERVAL = 3000;

// é¢æ¿éšè—çŠ¶æ€
let isProjectsHidden = false;
let isSessionsHidden = false;

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
console.log('=== é¡µé¢è„šæœ¬å·²åŠ è½½ ===');
console.log('togglePanel å‡½æ•°:', typeof togglePanel);

// æµ‹è¯•æŒ‰é’®ç‚¹å‡»
window.addEventListener('DOMContentLoaded', () => {
  console.log('=== DOM åŠ è½½å®Œæˆ ===');
  const projectBtn = document.querySelector('#projects-panel .panel-toggle');
  const sessionBtn = document.querySelector('#sessions-panel .panel-toggle');
  console.log('é¡¹ç›®é¢æ¿æŒ‰é’®:', projectBtn);
  console.log('å¯¹è¯é¢æ¿æŒ‰é’®:', sessionBtn);

  if (projectBtn) {
    projectBtn.addEventListener('click', () => {
      console.log('é¡¹ç›®é¢æ¿æŒ‰é’®è¢«ç‚¹å‡»ï¼ˆé€šè¿‡äº‹ä»¶ç›‘å¬å™¨ï¼‰');
    });
  }

  if (sessionBtn) {
    sessionBtn.addEventListener('click', () => {
      console.log('å¯¹è¯é¢æ¿æŒ‰é’®è¢«ç‚¹å‡»ï¼ˆé€šè¿‡äº‹ä»¶ç›‘å¬å™¨ï¼‰');
    });
  }
});

// æ ¼å¼åŒ–æ•°å­—
function fmtNum(n) {
  if (n == null) return '0';
  return n.toLocaleString();
}

// æ ¼å¼åŒ–æ—¶é—´
function fmtTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  return d.toLocaleString('zh-CN', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
}

function fmtTimeFull(ts) {
  if (!ts) return '';
  return new Date(ts).toLocaleString('zh-CN');
}

// æ›´æ–°æ»šåŠ¨æŒ‰é’®å¯è§æ€§
function updateScrollButtons() {
  const container = document.getElementById('messages');
  const topBtn = document.querySelector('#messages .scroll-btn:first-child');
  const bottomBtn = document.querySelector('#messages .scroll-btn:last-child');

  if (!container || !topBtn || !bottomBtn) return;

  const scrollTop = container.scrollTop;
  const scrollHeight = container.scrollHeight;
  const clientHeight = container.clientHeight;

  // é¡¶éƒ¨ï¼šæ»šåŠ¨ä½ç½® < 10
  topBtn.classList.toggle('hidden', scrollTop < 10);
  // åº•éƒ¨ï¼šè·ç¦»åº•éƒ¨ < 10
  bottomBtn.classList.toggle('hidden', scrollHeight - scrollTop - clientHeight < 10);
}

// æ»šåŠ¨å‡½æ•°
function scrollToTop() {
  const container = document.getElementById('messages');
  if (container) {
    container.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

function scrollToBottom() {
  const container = document.getElementById('messages');
  if (container) {
    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
  }
}

// åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨å¼€å…³
function toggleAutoScroll() {
  autoScrollToBottom = !autoScrollToBottom;
  const btn = document.getElementById('auto-scroll-btn');
  if (btn) {
    btn.classList.toggle('active', autoScrollToBottom);
    btn.title = autoScrollToBottom ? 'æ–°æ¶ˆæ¯è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨' : 'æ–°æ¶ˆæ¯ä¸ä¼šè‡ªåŠ¨æ»šåŠ¨';
  }
}

// åˆ‡æ¢é¢æ¿æ˜¾ç¤º/éšè—
function togglePanel(panel) {
  console.log('=== togglePanel è¢«è°ƒç”¨ ===');
  console.log('panel:', panel);
  console.log('isProjectsHidden (before):', isProjectsHidden);
  console.log('isSessionsHidden (before):', isSessionsHidden);

  const projectsPanel = document.getElementById('projects-panel');
  const sessionsPanel = document.getElementById('sessions-panel');

  console.log('projectsPanel:', projectsPanel);
  console.log('sessionsPanel:', sessionsPanel);

  if (panel === 'projects') {
    isProjectsHidden = !isProjectsHidden;
    console.log('isProjectsHidden (after toggle):', isProjectsHidden);

    const icon = document.getElementById('projects-toggle-icon');
    const header = projectsPanel.querySelector('.panel-header');
    const list = projectsPanel.querySelector('.panel-list');
    const headerText = header.childNodes[0]; // æ ‡é¢˜æ–‡å­—èŠ‚ç‚¹
    const count = header.querySelector('.count');

    console.log('icon:', icon);
    console.log('header:', header);
    console.log('list:', list);
    console.log('headerText:', headerText);
    console.log('count:', count);

    if (isProjectsHidden) {
      console.log('æ‰§è¡Œéšè—æ“ä½œ');
      projectsPanel.style.width = '48px';
      projectsPanel.style.minWidth = '48px';
      icon.textContent = 'â¯';
      list.style.display = 'none';
      headerText.textContent = '';
      count.style.display = 'none';
      header.style.justifyContent = 'center';
    } else {
      console.log('æ‰§è¡Œæ˜¾ç¤ºæ“ä½œ');
      projectsPanel.style.width = '260px';
      projectsPanel.style.minWidth = '260px';
      icon.textContent = 'â®';
      list.style.display = 'block';
      headerText.textContent = 'é¡¹ç›®åˆ—è¡¨ ';
      count.style.display = 'inline-block';
      header.style.justifyContent = 'flex-start';
    }
  }

  if (panel === 'sessions') {
    isSessionsHidden = !isSessionsHidden;
    console.log('isSessionsHidden (after toggle):', isSessionsHidden);

    const icon = document.getElementById('sessions-toggle-icon');
    const header = sessionsPanel.querySelector('.panel-header');
    const list = sessionsPanel.querySelector('.panel-list');
    const headerText = header.childNodes[0]; // æ ‡é¢˜æ–‡å­—èŠ‚ç‚¹
    const count = header.querySelector('.count');

    console.log('icon:', icon);
    console.log('header:', header);
    console.log('list:', list);
    console.log('headerText:', headerText);
    console.log('count:', count);

    if (isSessionsHidden) {
      console.log('æ‰§è¡Œéšè—æ“ä½œ');
      sessionsPanel.style.width = '48px';
      sessionsPanel.style.minWidth = '48px';
      icon.textContent = 'â¯';
      list.style.display = 'none';
      headerText.textContent = '';
      count.style.display = 'none';
      header.style.justifyContent = 'center';
    } else {
      console.log('æ‰§è¡Œæ˜¾ç¤ºæ“ä½œ');
      sessionsPanel.style.width = '300px';
      sessionsPanel.style.minWidth = '300px';
      icon.textContent = 'â®';
      list.style.display = 'block';
      headerText.textContent = 'å¯¹è¯åˆ—è¡¨ ';
      count.style.display = 'inline-block';
      header.style.justifyContent = 'flex-start';
    }
  }

  console.log('=== togglePanel æ‰§è¡Œå®Œæ¯• ===');
  // æ›´æ–°æ»šåŠ¨æŒ‰é’®
  setTimeout(updateScrollButtons, 300);
}

// åŠ è½½é¡¹ç›®åˆ—è¡¨
async function loadProjects() {
  const res = await fetch('/api/projects');
  const projects = await res.json();
  const el = document.getElementById('project-list');
  document.getElementById('project-count').textContent = projects.length;

  if (!projects.length) { el.innerHTML = '<div class="empty-state">æ²¡æœ‰æ‰¾åˆ°é¡¹ç›®</div>'; return; }

  renderProjectList(projects, el);
}

// é€‰æ‹©é¡¹ç›®
async function selectProject(id) {
  currentProject = id;
  currentSession = null;
  currentMessageCount = 0;
  clearInterval(autoRefreshTimers.messages);
  document.querySelectorAll('.project-item').forEach(e => e.classList.toggle('active', e.dataset.id === id));
  document.getElementById('session-list').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
  document.getElementById('messages').innerHTML = '<div class="empty-state">é€‰æ‹©ä¸€ä¸ªå¯¹è¯æŸ¥çœ‹è¯¦æƒ…</div>';
  document.getElementById('stats-bar').style.display = 'none';

  const res = await fetch(`/api/projects/${encodeURIComponent(id)}/sessions`);
  const sessions = await res.json();
  const el = document.getElementById('session-list');
  document.getElementById('session-count').textContent = sessions.length;

  if (!sessions.length) { el.innerHTML = '<div class="empty-state">æ²¡æœ‰å¯¹è¯è®°å½•</div>'; return; }

  renderSessionList(sessions, el);
  startSessionsRefresh();
}

// é€‰æ‹©å¯¹è¯
async function selectSession(id) {
  currentSession = id;
  currentMessageCount = 0;
  document.querySelectorAll('.session-item').forEach(e => e.classList.toggle('active', e.dataset.id === id));
  document.getElementById('messages').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

  const res = await fetch(`/api/sessions/${encodeURIComponent(currentProject)}/${encodeURIComponent(id)}`);
  const data = await res.json();
  renderStats(data.stats);
  renderMessages(data.messages);
  currentMessageCount = data.messages.length;
  // æ»šåŠ¨åˆ°åº•éƒ¨
  scrollToBottom();
  startMessagesRefresh();
}

// æ¸²æŸ“ç»Ÿè®¡æ 
function renderStats(stats) {
  const bar = document.getElementById('stats-bar');
  bar.style.display = 'flex';
  bar.innerHTML = `
    <button class="auto-scroll-toggle ${autoScrollToBottom ? 'active' : ''}" id="auto-scroll-btn" onclick="toggleAutoScroll()" title="${autoScrollToBottom ? 'æ–°æ¶ˆæ¯è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨' : 'æ–°æ¶ˆæ¯ä¸ä¼šè‡ªåŠ¨æ»šåŠ¨'}">
      <span class="icon">${autoScrollToBottom ? 'ğŸ“' : 'ğŸ“Œ'}</span>
      <span class="text">è‡ªåŠ¨æ»šåŠ¨</span>
    </button>
    <div class="stat-item input">Input Tokens:<span>${stats.totalInputTokens}</span></div>
    <div class="stat-item output">Output Tokens:<span>${stats.totalOutputTokens}</span></div>
    <div class="stat-item cache-create">Cache Creation:<span>${stats.totalCacheCreationTokens}</span></div>
    <div class="stat-item cache-read">Cache Read:<span>${stats.totalCacheReadTokens}</span></div>
    <div class="stat-item">æ¶ˆæ¯æ•°:<span>${stats.messageCount}</span></div>
    <div class="stat-item">User:<span>${stats.userTurns}</span></div>
    <div class="stat-item">Assistant:<span>${stats.assistantTurns}</span></div>
    <div class="stat-item">æ¨¡å‹:<span>${stats.models.join(', ') || '-'}</span></div>
    ${stats.sessionId ? `<div class="stat-item">Session:<span title="${stats.sessionId}">${fmtSessionId(stats.sessionId)}</span></div>` : ''}
    <div class="stat-item throughput">Throughput:<span>${Math.round(stats.throughput)} token/s</span></div>
    <div class="stat-item duration">è€—æ—¶:<span>${fmtDuration(stats.totalDurationSec)}</span></div>
   
  `;
}

function fmtSessionId(id) {
  return id.length > 20 ? id.substring(0, 8) + '...' + id.substring(id.length - 8) : id;
}

function fmtDuration(seconds) {
  if (seconds < 60) {
    return seconds.toFixed(1) + ' ç§’';
  } else {
    const minutes = seconds / 60;
    return minutes.toFixed(1) + ' åˆ†é’Ÿ';
  }
}

// æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
function renderMessages(messages) {
  const el = document.getElementById('messages');
  if (!messages.length) {
    el.innerHTML = `<div class="empty-state">æ²¡æœ‰æ¶ˆæ¯</div>
    <div class="scroll-buttons" style="position:absolute">
      <button class="scroll-btn" onclick="scrollToTop()" title="æ»šåŠ¨åˆ°é¡¶éƒ¨">â†‘</button>
      <button class="scroll-btn" onclick="scrollToBottom()" title="æ»šåŠ¨åˆ°åº•éƒ¨">â†“</button>
    </div>`;
    return;
  }

  el.innerHTML = messages.map(renderMessage).join('') + `
    <div class="scroll-buttons">
      <button class="scroll-btn" onclick="scrollToTop()" title="æ»šåŠ¨åˆ°é¡¶éƒ¨">â†‘</button>
      <button class="scroll-btn" onclick="scrollToBottom()" title="æ»šåŠ¨åˆ°åº•éƒ¨">â†“</button>
    </div>`;
  el.querySelectorAll('pre code').forEach(block => {
    try { hljs.highlightElement(block); } catch {}
  });
  // æ›´æ–°æŒ‰é’®å¯è§æ€§
  setTimeout(updateScrollButtons, 100);
}

function renderMessage(msg) {
  const sidechainClass = msg.isSidechain ? ' sidechain' : '';
  if (msg.type === 'system') {
    return `<div class="message system${sidechainClass}">
      <div class="msg-header"><span class="msg-role system">SYSTEM${msg.subtype ? ' Â· ' + msg.subtype : ''}</span><span class="msg-time">${fmtTimeFull(msg.timestamp)}</span></div>
      <div class="msg-body">${escHtml(typeof msg.content === 'string' ? msg.content : JSON.stringify(msg.content))}</div>
    </div>`;
  }

  if (msg.type === 'user') {
    return `<div class="message user${sidechainClass}">
      <div class="msg-header"><span class="msg-role user">USER</span><span class="msg-time">${fmtTimeFull(msg.timestamp)}</span></div>
      <div class="msg-body">${renderContent(msg.content)}</div>
    </div>`;
  }

  if (msg.type === 'assistant') {
    const u = msg.usage || {};
    let tokensHtml = '';
    if (u.inputTokens || u.outputTokens || u.cacheCreationTokens || u.cacheReadTokens) {
      tokensHtml = `<div class="msg-tokens">
        <span class="token-badge input">IN ${u.inputTokens}</span>
        <span class="token-badge output">OUT ${u.outputTokens}</span>
        ${u.cacheCreationTokens ? `<span class="token-badge cache-create">CACHE+ ${u.cacheCreationTokens}</span>` : ''}
        ${u.cacheReadTokens ? `<span class="token-badge cache-read">CACHEâ†“ ${u.cacheReadTokens}</span>` : ''}
      </div>`;
    }
    let responseTimeHtml = '';
    if (msg.responseTimeSec !== undefined) {
      responseTimeHtml = `<span class="msg-response-time" title="ä»ç”¨æˆ·æ¶ˆæ¯åˆ°å›å¤è€—æ—¶">${msg.responseTimeSec.toFixed(2)} ç§’</span>`;
    }
    return `<div class="message assistant${sidechainClass}">
      <div class="msg-header">
        <span class="msg-role assistant">ASSISTANT</span>
        <span class="msg-time">${fmtTimeFull(msg.timestamp)}</span>
        ${msg.model ? `<span class="msg-model">${msg.model}</span>` : ''}
        ${responseTimeHtml}
        ${msg.stopReason ? `<span class="msg-stop">${msg.stopReason}</span>` : ''}
      </div>
      <div class="msg-body">${renderContent(msg.content)}</div>
      ${tokensHtml}
    </div>`;
  }

  return '';
}

// æ¸²æŸ“æ¶ˆæ¯å†…å®¹ï¼ˆæ”¯æŒå­—ç¬¦ä¸²å’Œæ•°ç»„ï¼‰
function renderContent(content) {
  if (!content) return '';
  if (typeof content === 'string') return renderMarkdown(content);
  if (!Array.isArray(content)) return escHtml(JSON.stringify(content));

  return content.map(block => {
    if (block.type === 'text') return renderMarkdown(block.text);
    if (block.type === 'tool_use') {
      const inputStr = JSON.stringify(block.input, null, 2);

      // æ£€æµ‹æ˜¯å¦æ˜¯ Edit/Write å·¥å…·è°ƒç”¨ï¼Œéœ€è¦æ˜¾ç¤ºå·®å¼‚å¯¹æ¯”
      let diffHtml = '';
      if ((block.name === 'Edit' || block.name === 'Write' || block.name === 'NotebookEdit') && block.input) {
        const { old_string, new_string, file_path } = block.input;
        if (old_string !== undefined && new_string !== undefined) {
          diffHtml = renderCodeDiff(old_string, new_string, file_path || 'untitled');
        }
      }

      // å¦‚æœæœ‰å·®å¼‚å¯¹æ¯”ï¼Œæ˜¾ç¤ºåœ¨å·¥å…·å—ä¸­
      if (diffHtml) {
        return `<details class="tool-block" open>
          <summary>ğŸ”§ ${escHtml(block.name)}${block.input.file_path ? ` - ${escHtml(block.input.file_path)}` : ''}</summary>
          <div class="tool-content">${diffHtml}</div>
        </details>`;
      }

      // é»˜è®¤æ˜¾ç¤º JSON
      return `<details class="tool-block" open><summary>ğŸ”§ ${escHtml(block.name)}</summary>
        <div class="tool-content"><pre><code class="language-json">${escHtml(inputStr)}</code></pre></div></details>`;
    }
    if (block.type === 'tool_result') {
      const resultText = typeof block.content === 'string' ? block.content : JSON.stringify(block.content, null, 2);
      return `<details class="tool-block" open><summary>ğŸ“‹ Tool Result (${escHtml(block.tool_use_id || '')})</summary>
        <div class="tool-content"><pre><code>${escHtml(resultText)}</code></pre></div></details>`;
    }
    if (block.type === 'thinking') {
      return `<details class="tool-block" open><summary>ğŸ’­ Thinking</summary>
        <div class="tool-content">${renderMarkdown(block.thinking || '')}</div></details>`;
    }
    return `<details class="tool-block" open><summary>${escHtml(block.type || 'unknown')}</summary>
      <div class="tool-content"><pre><code>${escHtml(JSON.stringify(block, null, 2))}</code></pre></div></details>`;
  }).join('');
}

// æ¸²æŸ“ä»£ç å·®å¼‚å¯¹æ¯”
function renderCodeDiff(oldCode, newCode, filePath) {
  try {
    // ä½¿ç”¨ jsdiff ç”Ÿæˆå·®å¼‚
    const diff = window.Diff.diffLines(oldCode, newCode);

    // åˆ†åˆ«æ„å»ºå·¦å³ä¸¤ä¾§çš„ HTML
    let oldHtml = '<div class="diff-old-header">æ—§ä»£ç </div><div class="diff-old">';
    let newHtml = '<div class="diff-new-header">æ–°ä»£ç </div><div class="diff-new">';

    let oldLineNum = 1;
    let newLineNum = 1;

    diff.forEach(part => {
      const lines = part.value.split('\n').filter(l => l !== '');

      if (part.removed) {
        // åˆ é™¤çš„è¡Œ - åªæ˜¾ç¤ºåœ¨å·¦ä¾§
        lines.forEach(line => {
          oldHtml += `<div class="diff-line removed">
            <div class="diff-line-num">${oldLineNum++}</div>
            <div class="diff-line-content">- ${escHtml(line)}</div>
          </div>`;
        });
        // å³ä¾§æ˜¾ç¤ºç©ºç™½å ä½
        lines.forEach(() => {
          newHtml += `<div class="diff-line">
            <div class="diff-line-num"></div>
            <div class="diff-line-content"></div>
          </div>`;
        });
      } else if (part.added) {
        // æ–°å¢çš„è¡Œ - åªæ˜¾ç¤ºåœ¨å³ä¾§
        lines.forEach(line => {
          newHtml += `<div class="diff-line added">
            <div class="diff-line-num">${newLineNum++}</div>
            <div class="diff-line-content">+ ${escHtml(line)}</div>
          </div>`;
        });
        // å·¦ä¾§æ˜¾ç¤ºç©ºç™½å ä½
        lines.forEach(() => {
          oldHtml += `<div class="diff-line">
            <div class="diff-line-num"></div>
            <div class="diff-line-content"></div>
          </div>`;
        });
      } else {
        // ç›¸åŒçš„è¡Œ - ä¸¤ä¾§éƒ½æ˜¾ç¤º
        lines.forEach(line => {
          oldHtml += `<div class="diff-line">
            <div class="diff-line-num">${oldLineNum++}</div>
            <div class="diff-line-content">${escHtml(line)}</div>
          </div>`;
          newHtml += `<div class="diff-line">
            <div class="diff-line-num">${newLineNum++}</div>
            <div class="diff-line-content">${escHtml(line)}</div>
          </div>`;
        });
      }
    });

    oldHtml += '</div>';
    newHtml += '</div>';

    // ç»Ÿè®¡å˜åŒ–
    const stats = calculateDiffStats(oldCode, newCode);

    return `
      <div class="diff-container">
        <div class="diff-header">
          <div class="diff-file-path" title="${escHtml(filePath)}">ğŸ“„ ${escHtml(filePath)}</div>
          <div class="diff-stats">
            <span class="diff-stat added">+${stats.added}</span>
            <span class="diff-stat removed">-${stats.removed}</span>
            ${stats.changed > 0 ? `<span class="diff-stat changed">Â±${stats.changed}</span>` : ''}
          </div>
        </div>
        <div class="diff-wrapper">
          ${oldHtml}
          ${newHtml}
        </div>
      </div>`;
  } catch (error) {
    console.error('æ¸²æŸ“å·®å¼‚å¯¹æ¯”å¤±è´¥:', error);
    // é™çº§æ˜¾ç¤ºåŸå§‹ JSON
    return `<pre><code class="language-json">${escHtml(JSON.stringify({ old_string: oldCode, new_string: newCode }, null, 2))}</code></pre>`;
  }
}

// è®¡ç®—å·®å¼‚ç»Ÿè®¡
function calculateDiffStats(oldStr, newStr) {
  const oldLines = oldStr.split('\n');
  const newLines = newStr.split('\n');

  let added = 0, removed = 0, changed = 0;

  // ç®€å•ç»Ÿè®¡
  if (oldLines.length === newLines.length) {
    // å¯èƒ½æ˜¯ä¿®æ”¹
    for (let i = 0; i < oldLines.length; i++) {
      if (oldLines[i] !== newLines[i]) changed++;
    }
  } else {
    // æœ‰å¢å‡
    const maxLen = Math.max(oldLines.length, newLines.length);
    for (let i = 0; i < maxLen; i++) {
      if (i >= oldLines.length) added++;
      else if (i >= newLines.length) removed++;
      else if (oldLines[i] !== newLines[i]) {
        // å°è¯•åˆ¤æ–­æ˜¯ä¿®æ”¹è¿˜æ˜¯å¢åˆ 
        if (newLines.includes(oldLines[i])) {
          removed++;
        } else if (oldLines.includes(newLines[i])) {
          added++;
        } else {
          changed++;
        }
      }
    }
  }

  return { added, removed, changed };
}

function renderMarkdown(text) {
  try { return marked.parse(text || ''); } catch { return escHtml(text); }
}

function escHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// è‡ªåŠ¨åˆ·æ–°ï¼šé¡¹ç›®åˆ—è¡¨
function startProjectsRefresh() {
  clearInterval(autoRefreshTimers.projects);
  autoRefreshTimers.projects = setInterval(async () => {
    try {
      const res = await fetch('/api/projects');
      const projects = await res.json();
      const list = document.getElementById('project-list');
      const oldCount = list.children.length;
      // åªåœ¨æ•°é‡æˆ–é¡ºåºå˜åŒ–æ—¶æ›´æ–°ï¼ˆé¿å…é—ªçƒï¼‰
      const newIds = projects.map(p => p.id).join(',');
      const oldIds = [...list.children].map(el => el.dataset.id).join(',');
      if (newIds !== oldIds) {
        renderProjectList(projects, list);
      }
    } catch {}
  }, REFRESH_INTERVAL);
}

// è‡ªåŠ¨åˆ·æ–°ï¼šå¯¹è¯åˆ—è¡¨
function startSessionsRefresh() {
  clearInterval(autoRefreshTimers.sessions);
  if (!currentProject) return;
  autoRefreshTimers.sessions = setInterval(async () => {
    try {
      const res = await fetch(`/api/projects/${encodeURIComponent(currentProject)}/sessions`);
      const sessions = await res.json();
      const list = document.getElementById('session-list');
      const newIds = sessions.map(s => s.id).join(',');
      const oldIds = [...list.children].map(el => el.dataset.id).join(',');
      if (newIds !== oldIds) {
        renderSessionList(sessions, list);
      }
    } catch {}
  }, REFRESH_INTERVAL);
}

// è‡ªåŠ¨åˆ·æ–°ï¼šå½“å‰å¯¹è¯å†…å®¹ï¼ˆå¢é‡è¿½åŠ ï¼‰
function startMessagesRefresh() {
  clearInterval(autoRefreshTimers.messages);
  if (!currentProject || !currentSession) return;

  autoRefreshTimers.messages = setInterval(async () => {
    try {
      const res = await fetch(`/api/sessions/${encodeURIComponent(currentProject)}/${encodeURIComponent(currentSession)}`);
      const data = await res.json();
      const container = document.getElementById('messages');

      if (!container) return;

      // è®¡ç®—æ¶ˆæ¯å·®å¼‚
      const currentMessageCount = container.querySelectorAll('.message').length;
      const hasNewMessages = data.messages.length > currentMessageCount;

      if (hasNewMessages) {
        // æœ‰æ–°æ¶ˆæ¯ï¼šæ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
        renderMessages(data.messages);
        renderStats(data.stats);

        // æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        if (autoScrollToBottom) {
          setTimeout(() => {
            scrollToBottom();
          }, 100);
        }
      } else {
        // æ²¡æœ‰æ–°æ¶ˆæ¯ï¼šåªæ›´æ–°ç»Ÿè®¡æ 
        renderStats(data.stats);
      }

    } catch {}
  }, REFRESH_INTERVAL);
}

function renderProjectList(projects, list) {
  list.innerHTML = projects.map(p => `
    <div class="project-item ${p.id === currentProject ? 'active' : ''}" data-id="${escHtml(p.id)}" onclick="selectProject('${escHtml(p.id)}')">
      <div class="name" title="${escHtml(p.displayName)}">${escHtml(p.displayName)}</div>
      <div class="meta"><span>${p.sessionCount} ä¸ªå¯¹è¯</span><span>${fmtTime(p.latestTimestamp)}</span></div>
    </div>`).join('');
}

function renderSessionList(sessions, list) {
  list.innerHTML = sessions.map(s => `
    <div class="session-item ${s.id === currentSession ? 'active' : ''}" data-id="${escHtml(s.id)}" onclick="selectSession('${escHtml(s.id)}')">
      <div class="preview">${escHtml(s.preview || s.id)}</div>
      <div class="meta"><span>${s.messageCount} æ¡æ¶ˆæ¯</span><span>${fmtTime(s.latestTimestamp)}</span></div>
    </div>`).join('');
}

// å¯åŠ¨
loadProjects();
startProjectsRefresh();

// ç›‘å¬æ»šåŠ¨äº‹ä»¶æ›´æ–°æŒ‰é’®å¯è§æ€§
const messagesEl = document.getElementById('messages');
if (messagesEl) {
  messagesEl.addEventListener('scroll', updateScrollButtons);
}
</script>
</body>
</html>
